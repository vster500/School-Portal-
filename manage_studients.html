<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Manage Students - Kenya School Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<style>
  body {
    font-family: 'Montserrat', Arial, sans-serif;
    background: linear-gradient(135deg, #e8f0fe, #98e6cf 80%);
    margin: 0;
    color: #233247;
  }
  header {
    background-color: #000;
    color: #fff;
    padding: 3rem 1.4rem 3rem 1.4rem;
    text-align: center;
    border-bottom-left-radius: 40px;
    border-bottom-right-radius: 40px;
    font-weight: 700;
    font-size: 2.2rem;
    letter-spacing: 0.02em;
  }
  main {
    max-width: 1020px;
    margin: 2.6rem auto 3rem;
    background: white;
    border-radius: 28px;
    padding: 2.7rem 3rem 3rem 3rem;
    box-shadow: 0 11px 30px 0 rgb(56 239 125 / 0.38);
  }
  @media (max-width: 650px) {
    main {padding: 1.5rem; margin: 1.6rem 0 2rem;}
    header {font-size: 1.5rem; padding: 1.3rem 1rem 1.3rem 1rem;}
    select, input[type=text] { width: 100% !important;}
  }
  .btn-primary {
    background: #14a800;
    color: #fff;
    font-weight: 700;
    padding: 0.7rem 1.8rem;
    border-radius: 30px;
    box-shadow: 0 4px 11px #58e034aa;
    cursor: pointer;
    border: none;
    font-size: 1.03rem;
    letter-spacing: 0.02em;
    transition: background 0.35s ease;
  }
  .btn-primary:hover {
    background: #0e6f2b;
    color: #def9de;
  }
  .btn-danger {
    background-color: #dc2626;
    color: #fff;
    padding: 0.55rem 1.3rem;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.92rem;
    border: none;
    cursor: pointer;
  }
  .btn-danger:hover {background-color: #991b1b;}
  .filters-wrap {margin-bottom: 1.9rem;}
  label {font-weight: 700; font-size: 1rem; margin-bottom: 0.35rem; color: #04382b;}
  select, input[type=text], input[type=file] {
    padding: 0.55rem 1rem;
    border-radius: 22px;
    border: 2px solid #1d8fff;
    width: 195px;
    font-size: 1.02rem;
    outline-offset: 0;
    transition: border-color 0.35s;
    color: #233247;
  }
  th, td {padding: 11px 12px; text-align: left;}
  th {background: #38ef7d; color: #023129; font-weight: 700;}
  tbody tr:nth-child(odd) {background: #f3f9f6;}
  tbody tr:hover {background: #befec8aa;}
  .modal-bg {
    display: none;
    position: fixed; inset:0;
    background: rgba(0,0,0,0.25);
    justify-content: center; align-items: center; z-index: 500;
  }
  .modal-bg.active {display: flex;}
  .modal {background: white; border-radius: 20px; box-shadow: 0 6px 15px rgba(0,0,0,0.15); padding: 30px 35px; max-width: 480px; width: 100%;}
  .modal h3 {font-weight: 700; font-size: 1.2rem; margin-bottom: 1.2rem; color: #13412e;}
  .modal-footer {display: flex; justify-content: flex-end; gap: 1rem; margin-top: 18px;}
  .modal-footer button {padding: 0.55rem 1.5rem; border-radius: 30px; font-weight: 700; font-size: 1rem; cursor: pointer;}
  .inline-btn {padding: 0.3rem 0.7rem; border-radius: 14px; font-size: 0.98rem; font-weight: 600;}
</style>
</head>
<body>
<header>Manage Students</header>
<main>

<!-- Filters row -->
  <div class="filters-wrap flex-row">
    <div>
      <label for="searchText">Search Students</label><br/>
      <input id="searchText" type="text" placeholder="Name or Assessment No." />
    </div>
    <div>
      <label for="filterLevel">Level</label><br/>
      <select id="filterLevel">
        <option value="">All Levels</option>
        <option value="Pre-primary">Pre-primary</option>
        <option value="Primary">Primary</option>
        <option value="JSS">Junior Secondary</option>
      </select>
    </div>
    <div>
      <label for="filterClass">Class</label><br/>
      <select id="filterClass" disabled>
        <option value="">Select level first</option>
      </select>
    </div>
    <button class="btn-primary" id="openAddModalBtn">Add Student</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Assessment No.</th>
        <th>Level</th>
        <th>Class</th>
        <th>Status</th>
        <th>Parent Contact</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="studentsTableBody">
      <tr><td colspan="7" style="text-align:center; padding: 1.6rem;">Loading students...</td></tr>
    </tbody>
  </table>

</main>

<!-- Modal for add/edit -->
<div class="modal-bg" id="studentModalBg">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">Add New Student</h3>
    <form id="studentForm" autocomplete="off">
      <label for="studentName">Name</label>
      <input id="studentName" name="studentName" type="text" placeholder="Student full name" required />
      <label for="assessmentNumber">Assessment Number</label>
      <div style="display:flex; gap:0.6rem;">
        <input id="assessmentNumber" name="assessmentNumber" type="text" placeholder="Assessment number" required style="flex:1;" />
        <button type="button" class="inline-btn btn-primary" id="autoAssessmentBtn">Auto</button>
      </div>
      <label for="studentLevel">Level</label>
      <select id="studentLevel" name="studentLevel" required>
        <option value="">Select Level</option>
        <option value="Pre-primary">Pre-primary</option>
        <option value="Primary">Primary</option>
        <option value="JSS">Junior Secondary</option>
      </select>
      <label for="studentClass">Class</label>
      <select id="studentClass" name="studentClass" required disabled>
        <option value="">Select level first</option>
      </select>
      <label for="studentStatus">Status</label>
      <select id="studentStatus" name="studentStatus" required>
        <option value="active">Active</option>
        <option value="repeat">Repeat</option>
        <option value="promoted">Promoted</option>
      </select>
      <label for="parentContact">Parent Contact</label>
      <input id="parentContact" name="parentContact" type="text" placeholder="Parent mobile / email" />
      <label for="studentPhoto">Student Photo</label>
      <input id="studentPhoto" name="studentPhoto" type="file" accept="image/*" capture="environment" />
      <div class="modal-footer">
        <button type="submit" class="btn-primary">Save</button>
        <button type="button" class="btn-danger" id="cancelStudentBtn">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBnpne91aBQsRYefwHO5fcaGliJTo8jhMk",
    authDomain: "school-portal-233f5.firebaseapp.com",
    projectId: "school-portal-233f5",
    storageBucket: "school-portal-233f5.appspot.com",
    messagingSenderId: "314984934331",
    appId: "1:314984934331:web:92922fcc7a959e1fa0729e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const schoolId = localStorage.getItem('schoolId') || 'school1';

  // LEVEL CLASSES DEFINITIONS
  const LEVEL_CLASSES = {
    'Pre-primary': ['pp1', 'pp2'],
    'Primary': ['Grade 1','Grade 2','Grade 3','Grade 4','Grade 5','Grade 6'],
    'JSS': ['Grade 7','Grade 8','Grade 9']
  };

  // --- DOM hooks ---
  const studentModalBg = document.getElementById('studentModalBg');
  const openAddModalBtn = document.getElementById('openAddModalBtn');
  const cancelStudentBtn = document.getElementById('cancelStudentBtn');
  const studentForm = document.getElementById('studentForm');
  const studentsTableBody = document.getElementById('studentsTableBody');
  const filterLevel = document.getElementById('filterLevel');
  const filterClass = document.getElementById('filterClass');
  const searchText = document.getElementById('searchText');
  const studentLevel = document.getElementById('studentLevel');
  const studentClass = document.getElementById('studentClass');
  const assessmentNumber = document.getElementById('assessmentNumber');
  const autoAssessmentBtn = document.getElementById('autoAssessmentBtn');

  // --- Populate class select based on level ---
  function populateClassDropdown(level, selectElement){
    selectElement.innerHTML = '';
    if(level && LEVEL_CLASSES[level]){
      selectElement.disabled = false;
      selectElement.innerHTML = '<option value="">Select Class</option>';
      LEVEL_CLASSES[level].forEach(cl => {
        const option = document.createElement('option');
        option.value = cl;
        option.text = cl;
        selectElement.appendChild(option);
      });
    }
    else {
      selectElement.disabled = true;
      selectElement.innerHTML = '<option value="">Select level first</option>';
    }
  }
  filterLevel.addEventListener('change', () => { populateClassDropdown(filterLevel.value, filterClass); applyFilters(); });
  studentLevel.addEventListener('change', () => populateClassDropdown(studentLevel.value, studentClass));

  // --- Auto-generate assessment number ---
  autoAssessmentBtn.addEventListener('click', () => {
    // Unique, readable, short pattern e.g. "ASM-YYMMDD-HHMM-XXX"
    const now = new Date();
    const rand = Math.floor(Math.random()*900 + 100);
    const str = `ASM-${now.getFullYear().toString().slice(-2)}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}-${String(now.getHours()).padStart(2,"0")}${String(now.getMinutes()).padStart(2,"0")}-${rand}`;
    assessmentNumber.value = str;
  });

  // --- Student list real-time ---
  let studentsLocal = [];
  let editStudentId = null;
  function loadStudents(){
    const studentsCol = collection(db, 'schools', schoolId, 'students');
    onSnapshot(studentsCol, snapshot => {
      studentsLocal = [];
      snapshot.forEach(doc => { studentsLocal.push({ id: doc.id, ...doc.data() }); });
      applyFilters();
    }, error => {
      studentsTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Failed to load students.</td></tr>';
    });
  }

  function renderStudentsTable(students){
    if(!students.length){
      studentsTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">No students found.</td></tr>';
      return;
    }
    studentsTableBody.innerHTML = '';
    students.forEach(stud => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${stud.name}</td>
        <td>${stud.assessmentNumber}</td>
        <td>${stud.level || '-'}</td>
        <td>${stud.class || '-'}</td>
        <td>${stud.status || '-'}</td>
        <td>${stud.parentContact || '-'}</td>
        <td>
          <button class="inline-btn btn-primary mr-1" onclick="editStudent('${stud.id}')">Edit</button>
          <button class="inline-btn btn-primary mr-1" onclick="promoteStudent('${stud.id}')">Promote</button>
          <button class="inline-btn btn-primary mr-1" onclick="repeatStudent('${stud.id}')">Repeat</button>
          <button class="inline-btn btn-danger" onclick="deleteStudent('${stud.id}')">Delete</button>
        </td>
      `;
      studentsTableBody.appendChild(tr);
    });
  }

  function applyFilters(){
    let filtered = [...studentsLocal];
    const stxt = searchText.value.toLowerCase();
    const lvl = filterLevel.value;
    const cl = filterClass.value;

    if(stxt){ filtered = filtered.filter(s => s.name.toLowerCase().includes(stxt) || (s.assessmentNumber && s.assessmentNumber.toLowerCase().includes(stxt))); }
    if(lvl){ filtered = filtered.filter(s => s.level === lvl); }
    if(cl){ filtered = filtered.filter(s => s.class === cl); }
    renderStudentsTable(filtered);
  }

  window.editStudent = (id) => {
    const stud = studentsLocal.find(s => s.id === id);
    if(!stud) return alert("Student not found");
    editStudentId = id;
    document.getElementById('modalTitle').textContent = 'Edit Student';
    studentForm.studentName.value = stud.name || "";
    assessmentNumber.value = stud.assessmentNumber || "";
    studentLevel.value = stud.level || "";
    populateClassDropdown(stud.level, studentClass);
    studentClass.value = stud.class || "";
    studentForm.studentStatus.value = stud.status || "active";
    studentForm.parentContact.value = stud.parentContact || "";
    studentModalBg.classList.add('active');
  };

  window.promoteStudent = async (id) => {
    const stud = studentsLocal.find(s => s.id === id);
    if(!stud) return alert("Student not found");
    const classes = LEVEL_CLASSES[stud.level] || [];
    const currIndex = classes.indexOf(stud.class);
    if(currIndex === -1) return alert("Invalid class for student");
    if(currIndex === classes.length -1){
      await updateDoc(doc(db, 'schools', schoolId, 'students', id), { status: 'promoted' });
      alert(`${stud.name} completed the highest class for ${stud.level}`);
    } else {
      await updateDoc(doc(db, 'schools', schoolId, 'students', id), { class: classes[currIndex + 1], status: 'active' });
      alert(`${stud.name} promoted to ${classes[currIndex + 1]}`);
    }
  };

  window.repeatStudent = async (id) => {
    if(!confirm('Mark this student to repeat the current class?')) return;
    await updateDoc(doc(db, 'schools', schoolId, 'students', id), { status: 'repeat' });
    alert('Student marked to repeat');
  };

  window.deleteStudent = async (id) => {
    if(!confirm('Confirm deleting student, this is irreversible!')) return;
    try{
      await deleteDoc(doc(db, 'schools', schoolId, 'students', id));
      alert('Student deleted');
    } catch(err) {
      alert('Delete failed: ' + err.message);
    }
  };

  openAddModalBtn.addEventListener('click', () => {
    editStudentId = null;
    document.getElementById('modalTitle').textContent = 'Add New Student';
    studentForm.reset();
    studentClass.disabled = true;
    studentModalBg.classList.add('active');
  });

  cancelStudentBtn.addEventListener('click', () => studentModalBg.classList.remove('active'));

  studentForm.addEventListener('submit', async e => {
    e.preventDefault();
    const name = studentForm.studentName.value.trim();
    const assessmentNo = assessmentNumber.value.trim();
    const level = studentLevel.value;
    const cls = studentClass.value;
    const status = studentForm.studentStatus.value;
    const parentContact = studentForm.parentContact.value.trim();
    const photoFile = studentForm.studentPhoto.files[0];

    if(!name || !assessmentNo || !level || !cls || !status){
      return alert('Please fill in all required fields');
    }
    let photoUrl = null;
    if(photoFile){
      const storageRef = ref(storage, `schools/${schoolId}/students_photos/${Date.now()}_${photoFile.name}`);
      await uploadBytes(storageRef, photoFile);
      photoUrl = await getDownloadURL(storageRef);
    }
    try {
      if(editStudentId){
        const docRef = doc(db, 'schools', schoolId, 'students', editStudentId);
        await updateDoc(docRef, { name, assessmentNumber: assessmentNo, level, class: cls, status, parentContact, ...(photoUrl ? {photoUrl} : {}) });
        alert('Student updated');
      } else {
        await addDoc(collection(db, 'schools', schoolId, 'students'), { name, assessmentNumber: assessmentNo, level, class: cls, status, parentContact, ...(photoUrl ? {photoUrl} : {}) });
        alert('Student added');
      }
      studentModalBg.classList.remove('active');
    } catch(error) {
      alert('Saving failed: ' + error.message);
    }
  });


  filterClass.addEventListener('change', applyFilters);
  filterLevel.addEventListener('change', () => populateClassDropdown(filterLevel.value, filterClass));
  filterLevel.addEventListener('change', applyFilters);
  searchText.addEventListener('input', applyFilters);

  loadStudents();
</script>
</body>
</html>
