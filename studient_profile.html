<!-- Save as student_profile.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f4f6f9; font-family: "Segoe UI", Tahoma, Verdana, sans-serif; }
    header { background: #2c3e50; color: #fff; padding: 14px; text-align:center; font-weight:700; }
    .card { max-width:800px; margin:auto; margin-top:20px; border-radius:10px; overflow:hidden; }
    .profile-img { width:120px; height:120px; object-fit:cover; border-radius:50%; }
    .section-title { font-weight:700; margin-top:12px; }
    .btn-gap { gap:8px; display:flex; flex-wrap:wrap; }
    body.dark { background:#1e1e1e; color:#eee; }
    body.dark .card { background:#222; color:#f1c40f; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

  <header>üìñ Student Profile</header>

  <div class="card shadow p-4 bg-white">
    <div class="text-center mb-3">
      <img id="studentPhoto" class="profile-img" src="https://via.placeholder.com/120" alt="Student photo">
    </div>

    <h3 id="studentName" class="text-center mb-0"></h3>
    <p id="studentClass" class="text-center text-muted small mb-3"></p>

    <div id="infoArea">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Admission No:</strong> <span id="studentAdm"></span></p>
          <p><strong>Date of Birth:</strong> <span id="studentDob"></span></p>
        </div>
        <div class="col-md-6">
          <p><strong>Parent Name:</strong> <span id="parentName"></span></p>
          <p><strong>Parent Contact:</strong> <span id="parentContact"></span></p>
        </div>
      </div>

      <hr>

      <div>
        <h6 class="section-title">Performance</h6>
        <p id="performanceNotes">Loading...</p>
        <textarea id="editPerformanceNotes" class="form-control hidden" rows="3"></textarea>
      </div>

      <div id="medicalSection" class="mt-3">
        <h6 class="section-title">Medical</h6>
        <p id="medicalNotes">Restricted</p>
        <textarea id="editMedicalNotes" class="form-control hidden" rows="3"></textarea>
      </div>

      <div class="mt-3 text-muted small">
        Last Updated: <span id="lastUpdated">N/A</span>
      </div>
    </div>

    <!-- Role-based action area -->
    <div id="actionArea" class="mt-3">
      <div id="adminActions" class="btn-gap hidden mt-2">
        <button id="promoteBtn" class="btn btn-warning">‚¨ÜÔ∏è Promote</button>
        <button id="editBtn" class="btn btn-secondary">‚úèÔ∏è Edit Profile</button>
        <button id="deleteBtn" class="btn btn-danger">üóëÔ∏è Delete</button>
      </div>

      <div id="teacherActions" class="btn-gap hidden mt-2">
        <button id="enableEditPerfBtn" class="btn btn-primary">‚úçÔ∏è Edit Performance</button>
        <button id="savePerformanceBtn" class="btn btn-success hidden">üíæ Save Performance</button>
      </div>

      <div id="medicalActions" class="btn-gap hidden mt-2">
        <button id="enableEditMedicalBtn" class="btn btn-outline-danger">ü©∫ Edit Medical</button>
        <button id="saveMedicalBtn" class="btn btn-danger hidden">üíæ Save Medical</button>
      </div>

      <div id="parentNotice" class="mt-2 text-muted small hidden">
        You have read-only access to this profile.
      </div>
    </div>

    <div class="mt-3 text-center">
      <a href="manage_students.html" class="text-decoration-none">‚Üê Back to Manage Students</a>
    </div>
  </div>

  <!-- Firebase Auth + Firestore Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBnpne91aBQsRYefwHO5fcaGliJTo8jhMk",
      authDomain: "school-portal-233f5.firebaseapp.com",
      projectId: "school-portal-233f5",
      storageBucket: "school-portal-233f5.firebasestorage.app",
      messagingSenderId: "314984934331",
      appId: "1:314984934331:web:92922fcc7a959e1fa0729e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const el = id => document.getElementById(id);
    const studentName = el("studentName");
    const studentClass = el("studentClass");
    const studentAdm = el("studentAdm");
    const studentDob = el("studentDob");
    const parentName = el("parentName");
    const parentContact = el("parentContact");
    const performanceNotes = el("performanceNotes");
    const medicalNotes = el("medicalNotes");
    const studentPhoto = el("studentPhoto");
    const lastUpdated = el("lastUpdated");

    const adminActions = el("adminActions");
    const teacherActions = el("teacherActions");
    const medicalActions = el("medicalActions");
    const parentNotice = el("parentNotice");

    const editPerfArea = el("editPerformanceNotes");
    const editMedArea = el("editMedicalNotes");
    const enableEditPerfBtn = el("enableEditPerfBtn");
    const savePerformanceBtn = el("savePerformanceBtn");
    const enableEditMedicalBtn = el("enableEditMedicalBtn");
    const saveMedicalBtn = el("saveMedicalBtn");
    const promoteBtn = el("promoteBtn");
    const editBtn = el("editBtn");
    const deleteBtn = el("deleteBtn");

    let permissionsDiv = document.createElement("div");
    permissionsDiv.id = "permissionsList";
    permissionsDiv.className = "mt-3";
    el("infoArea").appendChild(permissionsDiv);

    const classOrder = ["PP1","PP2","Class 1","Class 2","Class 3","Class 4","Class 5","Class 6",
                        "JSS 7","JSS 8","JSS 9","Form 1","Form 2","Form 3","Form 4","Alumni"];

    let currentUserId = null;
    let schoolId = null;
    let studentId = new URLSearchParams(window.location.search).get("id");
    let role = "parent";
    let viewerContact = null;

    async function logUpdate(action){
      if (!currentUserId || !schoolId || !studentId) return;
      await addDoc(collection(db, `schools/${schoolId}/logs`), {
        studentId, userId: currentUserId, action, timestamp: new Date()
      });
    }

    async function loadStudent(){
      if (!schoolId || !studentId) return;
      const studentRef = doc(db, "schools", schoolId, "students", studentId);
      const snap = await getDoc(studentRef);
      if(!snap.exists()){ alert("Student not found"); return; }
      const data = snap.data();

      if(role==="parent" && viewerContact && data.parentContact!==viewerContact){
        el("infoArea").innerHTML="<p class='text-danger'>üö´ You can only view your own child's profile.</p>";
        parentNotice.classList.remove("hidden");
        return;
      }

      studentName.textContent = data.name||"‚Äî";
      studentClass.textContent = data.classLevel? "Class: "+data.classLevel:"";
      studentAdm.textContent = data.admission||"";
      studentDob.textContent = data.dob||"N/A";
      parentName.textContent = data.parentName||"N/A";
      parentContact.textContent = data.parentContact||"N/A";
      performanceNotes.textContent = data.performanceNotes||"No performance notes yet.";
      medicalNotes.textContent = (data.medicalNotes && (role==="admin"||role==="medical")) ? data.medicalNotes : (role==="parent"?"Restricted":(data.medicalNotes||"No medical notes."));
      studentPhoto.src = data.photoURL || "https://via.placeholder.com/120";
      lastUpdated.textContent = data.updatedAt ? new Date(data.updatedAt).toLocaleString() : "Not available";

      adminActions.classList.toggle("hidden", role!=="admin");
      teacherActions.classList.toggle("hidden", role!=="teacher");
      medicalActions.classList.toggle("hidden", role!=="medical");
      parentNotice.classList.toggle("hidden", role!=="parent");
    }

    async function loadStudentPermissions(){
      if(!schoolId||!studentId) return;
      const snap = await getDoc(doc(db,"schools",schoolId,"students",studentId));
      if(!snap.exists()) return;
      const assigned = snap.data().assignedTeachers||[];
      permissionsDiv.innerHTML="<strong>Assigned Teachers:</strong><br/>";
      for(let tId of assigned){
        const tSnap = await getDoc(doc(db,"schools",schoolId,"teachers",tId));
        if(tSnap.exists()) permissionsDiv.innerHTML += tSnap.data().name+" ("+tSnap.data().level+")<br/>";
      }
    }

    promoteBtn?.addEventListener("click", async()=>{
      const studentRef = doc(db,"schools",schoolId,"students",studentId);
      const snap = await getDoc(studentRef);
      if(!snap.exists()) return alert("Student not found");
      const current = snap.data().classLevel||"";
      const idx = classOrder.indexOf(current);
      const next = (idx>=0 && idx<classOrder.length-1)? classOrder[idx+1]: current;
      if(next===current) return alert("No next class defined or already at top level.");
      await updateDoc(studentRef,{classLevel:next,updatedAt:new Date()});
      await logUpdate("Promoted to "+next);
      alert("‚úÖ Promoted to "+next);
      loadStudent();
    });

    editBtn?.addEventListener("click", ()=>window.location.href=`edit_student.html?id=${encodeURIComponent(studentId)}`);

    deleteBtn?.addEventListener("click", async()=>{
      if(!confirm("Are you sure?")) return;
      const studentRef = doc(db,"schools",schoolId,"students",studentId);
      await deleteDoc(studentRef);
      await logUpdate("Deleted student");
      alert("‚úÖ Student deleted");
      window.location.href="manage_students.html";
    });

    enableEditPerfBtn?.addEventListener("click", ()=>{
      editPerfArea.classList.remove("hidden");
      editPerfArea.value = performanceNotes.textContent==="No performance notes yet."?"":performanceNotes.textContent;
      savePerformanceBtn.classList.remove("hidden");
      enableEditPerfBtn.classList.add("hidden");
    });

    savePerformanceBtn?.addEventListener("click", async()=>{
      const val = editPerfArea.value.trim();
      const studentRef = doc(db,"schools",schoolId,"students",studentId);
      await updateDoc(studentRef,{performanceNotes:val,updatedAt:new Date()});
      await logUpdate("Updated performance notes");
      editPerfArea.classList.add("hidden");
      savePerformanceBtn.classList.add("hidden");
      enableEditPerfBtn.classList.remove("hidden");
      loadStudent();
    });

    enableEditMedicalBtn?.addEventListener("click", ()=>{
      editMedArea.classList.remove("hidden");
      editMedArea.value = medicalNotes.textContent==="No medical notes."?"":medicalNotes.textContent;
      saveMedicalBtn.classList.remove("hidden");
      enableEditMedicalBtn.classList.add("hidden");
    });

    saveMedicalBtn?.addEventListener("click", async()=>{
      const val = editMedArea.value.trim();
      const studentRef = doc(db,"schools",schoolId,"students",studentId);
      await updateDoc(studentRef,{medicalNotes:val,updatedAt:new Date()});
      await logUpdate("Updated medical notes");
      editMedArea.classList.add("hidden");
      saveMedicalBtn.classList.add("hidden");
      enableEditMedicalBtn.classList.remove("hidden");
      loadStudent();
    });

    // Firebase Auth check
    onAuthStateChanged(auth, async (user)=>{
      if(!user) { alert("Sign in required"); window.location.href="login.html"; return; }
      currentUserId = user.uid;
      const userDoc = await getDoc(doc(db,"users",currentUserId));
      if(userDoc.exists()){
        const u = userDoc.data
