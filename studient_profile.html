<!-- Save as student_profile.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js"></script>
</head>
<body class="container py-4">
  <h2 class="text-center mb-4">Student Profile</h2>

  <div id="studentProfile" class="card shadow p-3">
    <div class="text-center mb-3">
      <img id="studentPhoto" class="rounded-circle" style="width:120px;height:120px;object-fit:cover;">
    </div>
    <h4 id="studentName" class="text-center"></h4>
    <p class="text-center text-muted" id="studentClass"></p>

    <!-- Sections -->
    <div class="mt-3">
      <h5>General Info</h5>
      <p><strong>Admission No:</strong> <span id="studentAdm"></span></p>
      <p><strong>Date of Birth:</strong> <span id="studentDob"></span></p>
    </div>

    <div class="mt-3">
      <h5>Parent Info</h5>
      <p><strong>Name:</strong> <span id="parentName"></span></p>
      <p><strong>Contact:</strong> <span id="parentContact"></span></p>
    </div>

    <div class="mt-3">
      <h5>Notes</h5>
      <p><strong>Performance:</strong> <span id="performanceNotes"></span></p>
      <textarea id="editPerformanceNotes" class="form-control d-none"></textarea>

      <div id="medicalSection" class="mt-2">
        <p><strong>Medical:</strong> <span id="medicalNotes"></span></p>
        <textarea id="editMedicalNotes" class="form-control d-none"></textarea>
      </div>
    </div>

    <div id="adminActions" class="mt-3 d-none">
      <button class="btn btn-warning" id="promoteBtn">Promote</button>
    </div>

    <div id="teacherActions" class="mt-3 d-none">
      <button class="btn btn-primary" id="savePerformanceBtn">Save Performance</button>
    </div>

    <div id="medicalActions" class="mt-3 d-none">
      <button class="btn btn-danger" id="saveMedicalBtn">Save Medical</button>
    </div>

    <p class="text-muted text-end mt-3"><small>Last Updated: <span id="lastUpdated"></span></small></p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const studentId = params.get("id");

    const role = localStorage.getItem("role"); // "admin", "teacher", "medical", "parent"

    const studentName = document.getElementById("studentName");
    const studentClass = document.getElementById("studentClass");
    const studentAdm = document.getElementById("studentAdm");
    const studentDob = document.getElementById("studentDob");
    const parentName = document.getElementById("parentName");
    const parentContact = document.getElementById("parentContact");
    const performanceNotes = document.getElementById("performanceNotes");
    const medicalNotes = document.getElementById("medicalNotes");
    const studentPhoto = document.getElementById("studentPhoto");
    const lastUpdated = document.getElementById("lastUpdated");

    const editPerformanceNotes = document.getElementById("editPerformanceNotes");
    const editMedicalNotes = document.getElementById("editMedicalNotes");

    const adminActions = document.getElementById("adminActions");
    const teacherActions = document.getElementById("teacherActions");
    const medicalActions = document.getElementById("medicalActions");

    db.collection("students").doc(studentId).get().then(doc => {
      if (doc.exists) {
        const data = doc.data();
        studentName.textContent = data.name;
        studentClass.textContent = "Class: " + data.class;
        studentAdm.textContent = data.adm;
        studentDob.textContent = data.dob;
        parentName.textContent = data.parentName;
        parentContact.textContent = data.parentContact;
        performanceNotes.textContent = data.performanceNotes || "N/A";
        medicalNotes.textContent = data.medicalNotes || "Restricted";
        studentPhoto.src = data.photoUrl || "https://via.placeholder.com/120";
        lastUpdated.textContent = data.updatedAt ? new Date(data.updatedAt.toDate()).toLocaleString() : "Not available";

        // Role-based controls
        if (role === "admin") {
          adminActions.classList.remove("d-none");
        }
        if (role === "teacher") {
          editPerformanceNotes.classList.remove("d-none");
          editPerformanceNotes.value = data.performanceNotes || "";
          teacherActions.classList.remove("d-none");
        }
        if (role === "medical") {
          editMedicalNotes.classList.remove("d-none");
          editMedicalNotes.value = data.medicalNotes || "";
          medicalActions.classList.remove("d-none");
        }
        if (role === "parent") {
          document.getElementById("medicalSection").style.display = "none"; // hide medical info
        }
      }
    });

    // Promotion logic for admin
    const classOrder = [
      "Pre-Primary 1","Pre-Primary 2","Grade 1","Grade 2","Grade 3","Grade 4",
      "Grade 5","Grade 6","JSS 7","JSS 8","JSS 9","Form 1","Form 2","Form 3","Form 4","Alumni"
    ];

    document.getElementById("promoteBtn").addEventListener("click", () => {
      db.collection("students").doc(studentId).get().then(doc => {
        if (doc.exists) {
          let currentClass = doc.data().class;
          let nextIndex = classOrder.indexOf(currentClass) + 1;
          let nextClass = nextIndex < classOrder.length ? classOrder[nextIndex] : "Alumni";
          db.collection("students").doc(studentId).update({
            class: nextClass,
            updatedAt: new Date()
          }).then(() => {
            alert("Student promoted to " + nextClass);
            location.reload();
          });
        }
      });
    });

    // Teacher updates performance
    document.getElementById("savePerformanceBtn").addEventListener("click", () => {
      db.collection("students").doc(studentId).update({
        performanceNotes: editPerformanceNotes.value,
        updatedAt: new Date()
      }).then(() => {
        alert("Performance notes updated");
        location.reload();
      });
    });

    // Medical teacher updates medical notes
    document.getElementById("saveMedicalBtn").addEventListener("click", () => {
      db.collection("students").doc(studentId).update({
        medicalNotes: editMedicalNotes.value,
        updatedAt: new Date()
      }).then(() => {
        alert("Medical notes updated");
        location.reload();
      });
    });
  </script>
</body>
</html>
