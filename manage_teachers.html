<!-- Save as manage_teachers.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Teachers</title>

  <!-- Bootstrap for quick layout -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#f4f6f9; font-family: "Segoe UI", Tahoma, Verdana, sans-serif; }
    .card { border-radius:10px; }
    .avatar { width:56px; height:56px; object-fit:cover; border-radius:8px; }
    .chip { display:inline-block; padding:4px 8px; border-radius:999px; background:#eef2ff; margin-right:6px; margin-bottom:6px; font-size:0.85rem; }
    #darkToggle { position: fixed; right: 1rem; bottom: 1rem; z-index: 9999; }
    body.dark { background:#121212; color:#e6e6e6; }
    body.dark .card { background:#1e1e1e; color:#e6e6e6; }
    body.dark .chip { background: #2b2b2b; color: #f1c40f; }
    .hidden { display:none !important; }
    .cursor-pointer { cursor:pointer; }
  </style>
</head>
<body>

  <nav class="navbar bg-white shadow-sm mb-4">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">Manage Teachers</span>
      <div>
        <button id="logoutBtn" class="btn btn-outline-secondary btn-sm me-2">Logout</button>
        <button id="darkToggle" class="btn btn-sm btn-dark">Dark</button>
      </div>
    </div>
  </nav>

  <main class="container">

    <!-- Top controls -->
    <div class="row mb-3">
      <div class="col-md-8">
        <div class="input-group">
          <input id="searchInput" type="search" class="form-control" placeholder="Search teacher by name or contact...">
          <select id="filterLevel" class="form-select" style="max-width:160px;">
            <option value="">All Levels</option>
            <option value="Pre-Primary">Pre-Primary</option>
            <option value="Primary">Primary</option>
            <option value="JSS">JSS</option>
            <option value="Secondary">Secondary</option>
          </select>
          <select id="filterSubject" class="form-select" style="max-width:200px;">
            <option value="">All Subjects</option>
          </select>
        </div>
      </div>

      <div class="col-md-4 text-end">
        <button id="openAddBtn" class="btn btn-primary">+ Add Teacher</button>
      </div>
    </div>

    <!-- Permission denied -->
    <div id="permissionDenied" class="alert alert-danger hidden">
      Permission Denied — only admins can manage teachers.
    </div>

    <!-- Teachers List -->
    <div id="teachersList" class="row g-3"></div>

    <!-- Pagination -->
    <nav class="mt-3">
      <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>

    <!-- Add / Edit Modal -->
    <div class="modal fade" id="teacherModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content card p-3">
          <div class="modal-header">
            <h5 id="teacherModalTitle" class="modal-title">Add Teacher</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="teacherForm">
              <input type="hidden" id="teacherId">
              <div class="row g-2">
                <div class="col-md-3 text-center">
                  <img id="previewPhoto" class="avatar mb-2" src="https://via.placeholder.com/56" alt="photo">
                  <input id="photoFile" type="file" accept="image/*" class="form-control form-control-sm">
                </div>

                <div class="col-md-9">
                  <div class="mb-2">
                    <label class="form-label">Full name</label>
                    <input id="tName" class="form-control" required>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Contact (phone/email)</label>
                    <input id="tContact" class="form-control">
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Level</label>
                    <select id="tLevel" class="form-select" required>
                      <option value="">Select level</option>
                      <option value="Pre-Primary">Pre-Primary</option>
                      <option value="Primary">Primary</option>
                      <option value="JSS">JSS</option>
                      <option value="Secondary">Secondary</option>
                    </select>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Subjects (multiple)</label>
                    <select id="tSubjects" class="form-select" multiple size="6" required></select>
                    <div class="form-text">You can add new subjects manually using the input below (press Add)</div>
                    <div class="d-flex mt-2 gap-2">
                      <input id="newSubjectInput" class="form-control form-control-sm" placeholder="Add custom subject (e.g., Robotics)">
                      <button id="addSubjectBtn" type="button" class="btn btn-sm btn-outline-secondary">Add</button>
                    </div>
                  </div>

                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button id="saveTeacherBtn" type="button" class="btn btn-success">Save</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Last actions log preview -->
    <div class="mt-4">
      <h6>Recent Logs</h6>
      <div id="recentLogs" class="small text-muted"></div>
    </div>

  </main>

  <!-- Bootstrap + Firebase -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
  // ---- Firebase imports ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import {
    getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, limit, startAfter
  } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

  // ---- Config (use your project config) ----
  const firebaseConfig = {
    apiKey: "AIzaSyBnpne91aBQsRYefwHO5fcaGliJTo8jhMk",
    authDomain: "school-portal-233f5.firebaseapp.com",
    projectId: "school-portal-233f5",
    storageBucket: "school-portal-233f5.firebasestorage.app",
    messagingSenderId: "314984934331",
    appId: "1:314984934331:web:92922fcc7a959e1fa0729e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  // ---- DOM refs ----
  const permissionDenied = document.getElementById("permissionDenied");
  const teachersList = document.getElementById("teachersList");
  const searchInput = document.getElementById("searchInput");
  const filterLevel = document.getElementById("filterLevel");
  const filterSubject = document.getElementById("filterSubject");
  const openAddBtn = document.getElementById("openAddBtn");

  const teacherModalEl = document.getElementById("teacherModal");
  const teacherModal = new bootstrap.Modal(teacherModalEl, {});
  const teacherModalTitle = document.getElementById("teacherModalTitle");
  const teacherIdInput = document.getElementById("teacherId");
  const previewPhoto = document.getElementById("previewPhoto");
  const photoFile = document.getElementById("photoFile");
  const tName = document.getElementById("tName");
  const tContact = document.getElementById("tContact");
  const tLevel = document.getElementById("tLevel");
  const tSubjects = document.getElementById("tSubjects");
  const newSubjectInput = document.getElementById("newSubjectInput");
  const addSubjectBtn = document.getElementById("addSubjectBtn");
  const saveTeacherBtn = document.getElementById("saveTeacherBtn");

  const recentLogs = document.getElementById("recentLogs");
  const logoutBtn = document.getElementById("logoutBtn");
  const darkToggle = document.getElementById("darkToggle");

  // ---- state ----
  let currentUser = null;
  let schoolId = null;
  let currentRole = null;
  let teachers = []; // loaded array of { id, ...data }
  let allSubjects = new Set();
  let filteredTeachers = [];
  // pagination
  const PER_PAGE = 9;
  let currentPage = 1;

  // fallback subject lists (used if not provided in Firestore)
  const fallbackSubjectsByLevel = {
    "Pre-Primary": ["Counting", "English", "Arts"],
    "Primary": ["Mathematics", "English", "Science", "Social Studies"],
    "JSS": ["Mathematics", "English", "Biology", "Chemistry", "Physics"],
    "Secondary": ["Mathematics", "English", "Physics", "Chemistry", "Biology", "ICT"]
  };

  // ---- utilities ----
  const el = id => document.getElementById(id);
  function showError(msg){ alert(msg); }
  function showToast(msg){ /* quick notification */ console.info(msg); }

  // ---- auth & role check ----
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // not signed in — redirect to login or show permission if you prefer
      permissionDenied.classList.remove("hidden");
      permissionDenied.textContent = "Sign in required to manage teachers.";
      return;
    }
    currentUser = user;
    // fetch user profile to obtain schoolId and role
    try {
      const uDoc = await getDoc(doc(db, "users", currentUser.uid));
      if (!uDoc.exists()) {
        permissionDenied.classList.remove("hidden");
        permissionDenied.textContent = "User profile not found. Contact admin.";
        return;
      }
      const u = uDoc.data();
      schoolId = u.schoolId;
      currentRole = u.role || "parent";
      if (currentRole !== "admin") {
        permissionDenied.classList.remove("hidden");
        permissionDenied.textContent = "Permission Denied — only admins can manage teachers.";
        return;
      }
      permissionDenied.classList.add("hidden");
      // load initial data
      await loadSubjects();    // populate subject filter & modal subject list
      await loadTeachers();    // load teacher list
      await loadRecentLogs();  // load recent logs preview
    } catch (err) {
      console.error(err);
      showError("Failed to initialize: " + err.message);
    }
  });

  // logout
  logoutBtn.addEventListener("click", async ()=>{
    await signOut(auth);
    window.location.href = "login.html";
  });

  // dark mode
  function applyDarkMode() {
    const on = localStorage.getItem("darkMode")==="true";
    document.body.classList.toggle("dark", on);
    darkToggle.textContent = on ? "Light" : "Dark";
  }
  darkToggle.addEventListener("click", ()=>{
    localStorage.setItem("darkMode", localStorage.getItem("darkMode")==="true" ? "false" : "true");
    applyDarkMode();
  });
  applyDarkMode();

  // ---- load subjects (try Firestore collection 'subjects' -> doc per level) ----
  async function loadSubjects(){
    allSubjects = new Set();
    // populate filterSubject select with union of subjects
    const subjectsOptions = new Set();
    for (const lvl of Object.keys(fallbackSubjectsByLevel)) {
      // attempt to fetch Firestore doc at subjects/{level}
      try {
        const docSnap = await getDoc(doc(db, "subjects", lvl));
        if (docSnap.exists()){
          const list = docSnap.data().list || [];
          list.forEach(s => subjectsOptions.add(s));
          list.forEach(s => allSubjects.add(s));
        } else {
          fallbackSubjectsByLevel[lvl].forEach(s => subjectsOptions.add(s));
          fallbackSubjectsByLevel[lvl].forEach(s => allSubjects.add(s));
        }
      } catch(e){
        // on error just add fallback
        fallbackSubjectsByLevel[lvl].forEach(s => subjectsOptions.add(s));
        fallbackSubjectsByLevel[lvl].forEach(s => allSubjects.add(s));
      }
    }
    // fill filterSubject
    filterSubject.innerHTML = `<option value="">All Subjects</option>`;
    Array.from(subjectsOptions).sort().forEach(s => {
      const opt = document.createElement("option");
      opt.value = s; opt.textContent = s;
      filterSubject.appendChild(opt);
    });
    // fill modal select tSubjects (initially with union)
    refreshSubjectsInModal();
  }

  function refreshSubjectsInModal(){
    tSubjects.innerHTML = "";
    Array.from(allSubjects).sort().forEach(s => {
      const opt = document.createElement("option");
      opt.value = s; opt.textContent = s;
      tSubjects.appendChild(opt);
    });
  }

  addSubjectBtn.addEventListener("click", ()=>{
    const val = newSubjectInput.value.trim();
    if(!val) return;
    allSubjects.add(val);
    refreshSubjectsInModal();
    newSubjectInput.value = "";
    showToast("Subject added to list");
  });

  // ---- load teachers from Firestore ----
  async function loadTeachers(){
    if(!schoolId) return;
    teachers = [];
    try {
      const q = collection(db, "schools", schoolId, "teachers");
      const snap = await getDocs(q);
      snap.forEach(docSnap => {
        const data = docSnap.data();
        teachers.push({ id: docSnap.id, ...data });
      });
      // ensure allSubjects includes teacher subjects
      teachers.forEach(t => (t.subjects||[]).forEach(s => allSubjects.add(s)));
      refreshSubjectsInModal();
      applyFiltersAndRender();
    } catch(err){
      console.error(err);
      showError("Failed to load teachers: " + err.message);
    }
  }

  // ---- render & pagination ----
  function applyFiltersAndRender(){
    const q = searchInput.value.trim().toLowerCase();
    const lvl = filterLevel.value;
    const subj = filterSubject.value;
    filteredTeachers = teachers.filter(t => {
      if (lvl && (t.level || "") !== lvl) return false;
      if (subj && !(t.subjects || []).includes(subj)) return false;
      if (!q) return true;
      return (t.name || "").toLowerCase().includes(q) || (t.contact || "").toLowerCase().includes(q);
    });
    currentPage = 1;
    renderTeachers();
  }

  function renderTeachers(){
    teachersList.innerHTML = "";
    const start = (currentPage-1)*PER_PAGE;
    const pageItems = filteredTeachers.slice(start, start + PER_PAGE);

    if(pageItems.length === 0){
      teachersList.innerHTML = `<div class="col-12"><div class="alert alert-info">No teachers found.</div></div>`;
    }

    pageItems.forEach(t => {
      const col = document.createElement("div");
      col.className = "col-md-4";

      const card = document.createElement("div");
      card.className = "card p-3 h-100";

      const header = document.createElement("div");
      header.className = "d-flex align-items-center gap-3 mb-2";
      const img = document.createElement("img");
      img.src = t.photoURL || "https://via.placeholder.com/56";
      img.className = "avatar";
      img.alt = t.name;
      header.appendChild(img);

      const title = document.createElement("div");
      title.innerHTML = `<strong>${t.name || "—"}</strong><div class="text-muted small">${t.contact || ""}</div><div class="small text-muted">${t.level || ""}</div>`;
      header.appendChild(title);

      const body = document.createElement("div");
      (t.subjects || []).slice(0,6).forEach(s => {
        const span = document.createElement("span");
        span.className = "chip";
        span.textContent = s;
        body.appendChild(span);
      });

      const actions = document.createElement("div");
      actions.className = "mt-3 d-flex justify-content-end gap-2";
      const editBtn = document.createElement("button");
      editBtn.className = "btn btn-sm btn-outline-primary";
      editBtn.textContent = "Edit";
      editBtn.addEventListener("click", ()=> openEditModal(t.id));
      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-sm btn-outline-danger";
      delBtn.textContent = "Delete";
      delBtn.addEventListener("click", ()=> deleteTeacher(t.id));
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);

      card.appendChild(header);
      card.appendChild(body);
      card.appendChild(actions);
      col.appendChild(card);
      teachersList.appendChild(col);
    });

    renderPagination();
  }

  function renderPagination(){
    const total = filteredTeachers.length;
    const pages = Math.max(1, Math.ceil(total / PER_PAGE));
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    const makeLi = (text, disabled, onClick, active=false) => {
      const li = document.createElement("li");
      li.className = "page-item " + (disabled ? "disabled" : "") + (active ? " active" : "");
      const a = document.createElement("a");
      a.className = "page-link cursor-pointer";
      a.textContent = text;
      if (!disabled) a.addEventListener("click", onClick);
      li.appendChild(a);
      return li;
    };

    pagination.appendChild(makeLi("Prev", currentPage===1, ()=> { currentPage--; renderTeachers(); }));
    for(let p=1;p<=pages;p++){
      pagination.appendChild(makeLi(p, false, ()=>{ currentPage = p; renderTeachers(); }, p===currentPage));
    }
    pagination.appendChild(makeLi("Next", currentPage===pages, ()=> { currentPage++; renderTeachers(); }));
  }

  // ---- open add / edit modal ----
  openAddBtn.addEventListener("click", () => openAddModal());

  function resetForm(){
    teacherIdInput.value = "";
    previewPhoto.src = "https://via.placeholder.com/56";
    photoFile.value = "";
    tName.value = "";
    tContact.value = "";
    tLevel.value = "";
    // clear selections
    Array.from(tSubjects.options).forEach(opt => opt.selected = false);
  }

  function openAddModal(){
    resetForm();
    teacherModalTitle.textContent = "Add Teacher";
    teacherModal.show();
  }

  async function openEditModal(id){
    if(!schoolId) return;
    teacherModalTitle.textContent = "Edit Teacher";
    resetForm();
    try {
      const tDoc = await getDoc(doc(db, "schools", schoolId, "teachers", id));
      if(!tDoc.exists()) return showError("Teacher not found");
      const d = tDoc.data();
      teacherIdInput.value = id;
      previewPhoto.src = d.photoURL || previewPhoto.src;
      tName.value = d.name || "";
      tContact.value = d.contact || "";
      tLevel.value = d.level || "";
      // select subjects
      const subjects = d.subjects || [];
      Array.from(tSubjects.options).forEach(opt => opt.selected = subjects.includes(opt.value));
      teacherModal.show();
    } catch (err) {
      console.error(err);
      showError("Failed to load teacher: " + err.message);
    }
  }

  // ---- save teacher (create or update) ----
  saveTeacherBtn.addEventListener("click", async () => {
    if(!schoolId) return showError("Missing schoolId");
    const id = teacherIdInput.value || null;
    const name = tName.value.trim();
    if(!name) return showError("Please enter teacher name");
    const contact = tContact.value.trim();
    const level = tLevel.value;
    const subjects = Array.from(tSubjects.selectedOptions).map(o => o.value);

    try {
      // handle file upload if present
      let photoURL = null;
      if(photoFile.files.length){
        const file = photoFile.files[0];
        const storageRef = ref(storage, `schools/${schoolId}/teachers/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        photoURL = await getDownloadURL(storageRef);
      }

      if(!id){
        // create
        const newDocRef = await addDoc(collection(db, "schools", schoolId, "teachers"), {
          name, contact, level, subjects, photoURL: photoURL || null, createdAt: new Date(), createdBy: currentUser.uid
        });
        await logAction(`Added teacher ${name}`, newDocRef.id);
        showToast("Teacher added");
      } else {
        // update
        const teacherRef = doc(db, "schools", schoolId, "teachers", id);
        const updates = { name, contact, level, subjects, updatedAt: new Date(), updatedBy: currentUser.uid };
        if(photoURL) updates.photoURL = photoURL;
        await updateDoc(teacherRef, updates);
        await logAction(`Updated teacher ${name}`, id);
        showToast("Teacher updated");
      }
      teacherModal.hide();
      await loadTeachers();
    } catch (err) {
      console.error(err);
      showError("Failed to save teacher: " + err.message);
    }
  });

  // ---- delete teacher ----
  async function deleteTeacher(id){
    if(!confirm("Delete teacher? This cannot be undone.")) return;
    try {
      // optionally delete photo from storage (if you stored path in teacher doc you'd need to keep the storage path)
      // for now just delete firestore doc
      await deleteDoc(doc(db, "schools", schoolId, "teachers", id));
      await logAction("Deleted teacher", id);
      showToast("Teacher deleted");
      await loadTeachers();
    } catch(err){
      console.error(err);
      showError("Failed to delete: " + err.message);
    }
  }

  // ---- logging function ----
  async function logAction(action, teacherId=null){
    try {
      await addDoc(collection(db, "schools", schoolId, "logs"), {
        userId: currentUser.uid,
        teacherId: teacherId || null,
        action,
        timestamp: new Date()
      });
      // update recent logs view
      await loadRecentLogs();
    } catch(e) {
      console.error("Log failed", e);
    }
  }

  // ---- recent logs preview ----
  async function loadRecentLogs(){
    if(!schoolId) return;
    try {
      const logsCol = collection(db, "schools", schoolId, "logs");
      const q = query(logsCol, orderBy("timestamp", "desc"), limit(10));
      const snap = await getDocs(q);
      recentLogs.innerHTML = "";
      snap.forEach(s => {
        const d = s.data();
        const when = d.timestamp ? (new Date(d.timestamp.seconds ? d.timestamp.seconds * 1000 : d.timestamp)).toLocaleString() : "";
        const line = document.createElement("div");
        line.textContent = `${when} — ${d.action} (by ${d.userId || 'unknown'})`;
        recentLogs.appendChild(line);
      });
    } catch(err){
      console.error(err);
    }
  }

  // ---- search & filters events ----
  searchInput.addEventListener("input", ()=> applyFiltersAndRender());
  filterLevel.addEventListener("change", ()=> applyFiltersAndRender());
  filterSubject.addEventListener("change", ()=> applyFiltersAndRender());

  // simple debounce helper (optional)
  function debounce(fn, time=300){
    let t;
    return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), time); };
  }
  searchInput.addEventListener("input", debounce(()=> applyFiltersAndRender(), 250));

  // ---- initial fallback: if you want to test without auth: set localStorage keys (schoolId, role) and call loadSubjects/loadTeachers ----
  // e.g. localStorage.setItem('schoolId','school1'); localStorage.setItem('role','admin');
  (async function fallbackLoadIfNeeded(){
    if (!schoolId && localStorage.getItem("schoolId") && localStorage.getItem("role")==="admin"){
      schoolId = localStorage.getItem("schoolId");
      currentUser = { uid: localStorage.getItem("userId") || "local-admin" };
      currentRole = "admin";
      await loadSubjects();
      await loadTeachers();
      await loadRecentLogs();
    }
  })();

  </script>
</body>
</html>
