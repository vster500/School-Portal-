<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kenya School Portal - Login / Register</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 420px;
    margin: 3rem auto;
    margin: 3rem auto;
    padding: 2rem;
    background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
    border-radius: 15px;
    box-shadow: 0 6px 18px rgba(0, 122, 204, 0.4);
    color: #003366;
  }
  h1 {
    text-align: center;
    margin-bottom: 2rem;
    font-weight: 900;
    color: #004f80;
  }
  form {
    display: flex;
    flex-direction: column;
  }
  label {
    font-weight: 700;
    margin: 0.8rem 0 0.3rem 0;
  }
  input {
    padding: 0.45rem 0.7rem;
    font-size: 1rem;
    border-radius: 20px;
    border: 1.8px solid #007acc;
    transition: box-shadow 0.25s ease;
  }
  input:focus {
    box-shadow: 0 0 8px #0099ff;
    outline: none;
  }
  button {
    margin-top: 1rem;
    background-color: #007acc;
    color: white;
    font-weight: 700;
    border: none;
    border-radius: 30px;
    padding: 0.6rem 0;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 122, 204, 0.5);
  }
  button:hover {
    background-color: #005f99;
  }
  .toggle-link {
    margin-top: 1rem;
    color: #004f80;
    font-weight: 700;
    cursor: pointer;
    text-decoration: underline;
    text-align: center;
  }
  .error-msg, .success-msg {
    margin-top: 0.5rem;
    font-weight: 700;
  }
  .error-msg {
    color: #cc0000;
  }
  .success-msg {
    color: #006600;
  }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Kenya School Portal</h1>

<form id="loginForm">
  <label for="loginEmail">Email</label>
  <input type="email" id="loginEmail" autocomplete="username" required />
  <label for="loginPassword">Password</label>
  <input type="password" id="loginPassword" autocomplete="current-password" required />
  <button type="submit">Login</button>
  <div id="loginError" class="error-msg"></div>
  <div class="toggle-link" id="showRegister">Don't have an account? Register as Parent here</div>
</form>

<form id="registerForm" style="display:none;">
  <label for="regEmail">Email</label>
  <input type="email" id="regEmail" autocomplete="email" required />
  <label for="regPassword">Password</label>
  <input type="password" id="regPassword" autocomplete="new-password" required minlength="6" />
  <label for="regConfirmPassword">Confirm Password</label>
  <input type="password" id="regConfirmPassword" required minlength="6" />
  <button type="submit">Create Parent Account</button>
  <div id="registerError" class="error-msg"></div>
  <div id="registerSuccess" class="success-msg"></div>
  <div class="toggle-link" id="showLogin">Already have an account? Login here</div>
</form>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBnpne91aBQsRYefwHO5fcaGliJTo8jhMk",
    authDomain: "school-portal-233f5.firebaseapp.com",
    projectId: "school-portal-233f5",
    storageBucket: "school-portal-233f5.appspot.com",
    messagingSenderId: "314984934331",
    appId: "1:314984934331:web:92922fcc7a959e1fa0729e"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const showRegister = document.getElementById('showRegister');
  const showLogin = document.getElementById('showLogin');

  const loginEmail = document.getElementById('loginEmail');
  const loginPassword = document.getElementById('loginPassword');
  const loginError = document.getElementById('loginError');

  const regEmail = document.getElementById('regEmail');
  const regPassword = document.getElementById('regPassword');
  const regConfirmPassword = document.getElementById('regConfirmPassword');
  const registerError = document.getElementById('registerError');
  const registerSuccess = document.getElementById('registerSuccess');

  const mainAdminEmail = "levisbonventure@gmail.com";

  showRegister.onclick = () => {
    loginForm.style.display = 'none';
    registerForm.style.display = 'block';
    loginError.textContent = '';
    registerError.textContent = '';
    registerSuccess.textContent = '';
  };

  showLogin.onclick = () => {
    registerForm.style.display = 'none';
    loginForm.style.display = 'block';
    loginError.textContent = '';
    registerError.textContent = '';
    registerSuccess.textContent = '';
  };

  loginForm.addEventListener('submit', async e => {
    e.preventDefault();
    loginError.textContent = '';
    try {
      const userCredential = await auth.signInWithEmailAndPassword(loginEmail.value.trim(), loginPassword.value.trim());
      const user = userCredential.user;
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (!userDoc.exists) {
        loginError.textContent = "User profile not found. Please contact your school admin.";
        await auth.signOut();
        return;
      }
      const role = userDoc.data().role || 'parent';
      // Redirect based on role
      if (user.email === mainAdminEmail) {
        window.location.href = 'admin.html';
      } else if (role === 'admin') {
        window.location.href = 'admin_dashboard.html';
      } else if (role === 'teacher') {
        window.location.href = 'teacher_dashboard.html';
      } else {
        window.location.href = 'index.html';
      }
    } catch (err) {
      loginError.textContent = err.message;
    }
  });

  registerForm.addEventListener('submit', async e => {
    e.preventDefault();
    registerError.textContent = '';
    registerSuccess.textContent = '';

    if (regPassword.value !== regConfirmPassword.value) {
      registerError.textContent = "Passwords do not match.";
      return;
    }
    if (regPassword.value.length < 6) {
      registerError.textContent = "Password should be at least 6 characters.";
      return;
    }

    try {
      const userCredential = await auth.createUserWithEmailAndPassword(regEmail.value.trim(), regPassword.value);
      const user = userCredential.user;
      await db.collection('users').doc(user.uid).set({
        email: regEmail.value.trim(),
        role: 'parent',
        children: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
      registerSuccess.textContent = "Registration successful! You can now log in.";
      regEmail.value = '';
      regPassword.value = '';
      regConfirmPassword.value = '';
      await auth.signOut();
    } catch (err) {
      registerError.textContent = err.message;
    }
  });
</script>

</body>
</html>
