<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bulk Excel Upload - School Portal</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"/>
<style>
body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: #f9f9f9; color: #333; transition: background 0.3s, color 0.3s; }
header { background: #2c3e50; color: #fff; }
h2 { color: #2c3e50; }
.btn-primary { background: #2c3e50; color: #fff; }
.btn-primary:hover { background: #34495e; }
.btn-accent { background: #3498db; color: #fff; }
.btn-accent:hover { background: #2980b9; }
body.dark { background: #1e1e1e; color: #eee; }
body.dark section { background: #2b2b2b; }
body.dark h2 { color: #f1c40f; }
#darkModeToggle { position: fixed; bottom: 1.2rem; right: 1.2rem; background: #2c3e50; color: #fff; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: background 0.3s, transform 0.2s; }
#darkModeToggle:hover { background: #34495e; transform: scale(1.1); }
body.dark #darkModeToggle { background: #e67e22; }
</style>
</head>
<body class="text-gray-800">

<header class="p-4 flex justify-between items-center shadow">
  <div class="text-2xl font-bold">üìä Bulk Excel Upload</div>
  <button onclick="window.location.href='post_results.html'" class="btn-primary px-3 py-1 rounded">Back to Post Results</button>
</header>

<section class="max-w-5xl mx-auto mt-6 bg-white p-6 rounded-lg shadow space-y-4">
  <h2 class="text-xl font-bold mb-3">Upload Results via Excel</h2>

  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
    <select id="levelSelect" class="p-2 border rounded" onchange="populateGrades()">
      <option value="">Select Level</option>
      <option>Pre-Primary</option>
      <option>Primary</option>
      <option>JSS</option>
      <option>Secondary</option>
    </select>

    <select id="gradeSelect" class="p-2 border rounded">
      <option value="">Select Grade</option>
    </select>

    <select id="subjectSelect" class="p-2 border rounded">
      <option value="">Select Subject</option>
    </select>

    <select id="termSelect" class="p-2 border rounded">
      <option value="">Select Term</option>
      <option>Term 1</option>
      <option>Term 2</option>
      <option>Term 3</option>
    </select>

    <select id="examTypeSelect" class="p-2 border rounded">
      <option value="">Select Exam Type</option>
      <option>Opening</option>
      <option>Mid</option>
      <option>End</option>
    </select>

    <select id="yearSelect" class="p-2 border rounded"></select>
  </div>

  <div class="mt-4">
    <label class="block mb-1 font-semibold">Select Excel File (.xlsx)</label>
    <input type="file" id="excelFile" class="p-2 border rounded">
    <button onclick="uploadExcel()" class="btn-accent px-4 py-2 rounded mt-2">Upload Excel</button>
  </div>

  <div class="mt-4 p-3 bg-gray-100 border-l-4 border-blue-500 rounded text-sm text-gray-700">
  <strong>Excel Format Example:</strong> Each row represents one student‚Äôs result.<br>
  <ul class="list-disc list-inside">
    <li><strong>admissionNumber</strong> ‚Äì Student‚Äôs admission number</li>
    <li><strong>studentName</strong> ‚Äì Full name</li>
    <li><strong>mark</strong> ‚Äì Numeric (0‚Äì100)</li>
  </ul>
  <p class="text-xs text-gray-500 mt-1">The first row should contain these headers exactly.</p>
</div>
</section>

<button id="darkModeToggle">üåô</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, Timestamp } 
from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBnpne91aBQsRYefwHO5fcaGliJTo8jhMk",
  authDomain: "school-portal-233f5.firebaseapp.com",
  projectId: "school-portal-233f5",
  storageBucket: "school-portal-233f5.firebasestorage.app",
  messagingSenderId: "314984934331",
  appId: "1:314984934331:web:92922fcc7a959e1fa0729e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const schoolId = "school1";

// Populate years
const yearSelect = document.getElementById("yearSelect");
const currentYear = new Date().getFullYear();
for (let y = currentYear; y >= currentYear - 5; y--) {
  const opt = document.createElement("option");
  opt.value = y; opt.textContent = y;
  if(y===currentYear) opt.selected=true;
  yearSelect.appendChild(opt);
}

// Grade mapping
const gradeOptions = {
  "Pre-Primary":["PP1","PP2"],
  "Primary":["Grade 1","Grade 2","Grade 3","Grade 4","Grade 5","Grade 6",],
  "JSS":["Grade 7","Grade 8","Grade 9"],
  "Secondary":["Form 1","Form 2","Form 3","Form 4"]
};

// Load subjects added by admin
let allSubjects = [];
async function loadSubjectsFromAdmin() {
  const snapshot = await getDocs(collection(db,"schools",schoolId,"subjects"));
  allSubjects=[];
  snapshot.forEach(snap=>allSubjects.push(snap.data()));
}
loadSubjectsFromAdmin();

function populateGrades() {
  const level = document.getElementById("levelSelect").value;
  const gradeSelect = document.getElementById("gradeSelect");
  gradeSelect.innerHTML="<option value=''>Select Grade</option>";
  if(level && gradeOptions[level]){
    gradeOptions[level].forEach(g=>{
      const opt=document.createElement("option");
      opt.value=g; opt.textContent=g;
      gradeSelect.appendChild(opt);
    });
  }
  populateSubjects();
}

function populateSubjects() {
  const level=document.getElementById("levelSelect").value;
  const subjectSelect=document.getElementById("subjectSelect");
  subjectSelect.innerHTML="<option value=''>Select Subject</option>";
  allSubjects.forEach(sub=>{
    if(sub.level===level){
      const opt=document.createElement("option");
      opt.value=sub.name; opt.textContent=sub.name;
      subjectSelect.appendChild(opt);
    }
  });
}

// Placeholder for Excel upload handling
function uploadExcel(){
  const file = document.getElementById("excelFile").files[0];
  const level = document.getElementById("levelSelect").value;
  const grade = document.getElementById("gradeSelect").value;
  const subject = document.getElementById("subjectSelect").value;
  const term = document.getElementById("termSelect").value;
  const examType = document.getElementById("examTypeSelect").value;
  const year = document.getElementById("yearSelect").value;

  if(!file || !level || !grade || !subject || !term || !examType || !year){
    return alert("Please select all filters and choose an Excel file");
  }

  alert(`Excel upload will be processed for ${grade} - ${subject} - ${term} - ${examType} - ${year}.`);
  // Here you can integrate XLSX.js to read the file and save results in Firestore
}

// Dark mode toggle
const darkToggle=document.getElementById("darkModeToggle");
darkToggle.addEventListener("click",()=>{
  document.body.classList.toggle("dark");
  darkToggle.textContent=document.body.classList.contains("dark")?"‚òÄÔ∏è":"üåô";
  localStorage.setItem("darkMode",document.body.classList.contains("dark"));
});
if(localStorage.getItem("darkMode")==="true"){document.body.classList.add("dark"); darkToggle.textContent="‚òÄÔ∏è";}
</script>

</body>
</html>
