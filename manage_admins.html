<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Admins - Kenya School Portal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      color: #333;
      padding: 2rem;
      max-width: 800px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #006400;
    }
    label {
      display: block;
      margin: 0.8rem 0 0.3rem;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 0.6rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 1rem;
    }
    button {
      padding: 0.6rem 1rem;
      background: #006400;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #008000; }
    .delete-btn {
      background: #c0392b;
    }
    .delete-btn:hover {
      background: #e74c3c;
    }
    .msg {
      margin-top: 1rem;
      font-weight: bold;
      text-align: center;
    }
    .error { color: red; }
    .success { color: green; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    th, td {
      padding: 0.8rem;
      border-bottom: 1px solid #ccc;
      text-align: left;
    }
    th {
      background: #eaf5ea;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>Manage Admins</h1>

  <form id="adminForm">
    <label for="schoolSelect">Select School</label>
    <select id="schoolSelect" required>
      <option value="">-- Select School --</option>
    </select>

    <label for="email">Admin Email</label>
    <input type="email" id="email" required />

    <label for="password">Temporary Password</label>
    <input type="password" id="password" required minlength="6" />

    <button type="submit">Add Admin</button>
    <div id="msg" class="msg"></div>
  </form>

  <h2>Existing Admins</h2>
  <table id="adminsTable">
    <thead>
      <tr>
        <th>Email</th>
        <th>School</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBnpne91aBQsRYefwHO5fcaGliJTo8jhMk",
      authDomain: "school-portal-233f5.firebaseapp.com",
      projectId: "school-portal-233f5",
      storageBucket: "school-portal-233f5.appspot.com",
      messagingSenderId: "314984934331",
      appId: "1:314984934331:web:92922fcc7a959e1fa0729e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const schoolSelect = document.getElementById('schoolSelect');
    const adminForm = document.getElementById('adminForm');
    const msg = document.getElementById('msg');
    const adminsTable = document.querySelector("#adminsTable tbody");

    let schoolsMap = {}; // store schoolId -> name

    // Load schools into dropdown
    async function loadSchools() {
      const snapshot = await db.collection('schools').get();
      snapshot.forEach(doc => {
        schoolsMap[doc.id] = doc.data().name;
        const option = document.createElement('option');
        option.value = doc.id;
        option.textContent = doc.data().name;
        schoolSelect.appendChild(option);
      });
    }

    // Load admins list
    async function loadAdmins() {
      adminsTable.innerHTML = "";
      const snapshot = await db.collection('users').where("role", "==", "admin").get();
      snapshot.forEach(doc => {
        const data = doc.data();
        const tr = document.createElement("tr");

        const tdEmail = document.createElement("td");
        tdEmail.textContent = data.email;

        const tdSchool = document.createElement("td");
        tdSchool.textContent = schoolsMap[data.schoolId] || "Unknown";

        const tdAction = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.classList.add("delete-btn");
        delBtn.onclick = async () => {
          if (confirm("Delete this admin?")) {
            await db.collection("users").doc(doc.id).delete();
            loadAdmins();
          }
        };
        tdAction.appendChild(delBtn);

        tr.appendChild(tdEmail);
        tr.appendChild(tdSchool);
        tr.appendChild(tdAction);

        adminsTable.appendChild(tr);
      });
    }

    // Add admin
    adminForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = "";
      msg.className = "msg";

      const schoolId = schoolSelect.value;
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!schoolId) {
        msg.textContent = "Please select a school.";
        msg.classList.add("error");
        return;
      }

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const newUser = userCredential.user;

        await db.collection('users').doc(newUser.uid).set({
          email: email,
          role: "admin",
          schoolId: schoolId,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        msg.textContent = "Admin added successfully!";
        msg.classList.add("success");
        adminForm.reset();
        loadAdmins();
      } catch (err) {
        msg.textContent = err.message;
        msg.classList.add("error");
      }
    });

    // Initialize
    loadSchools().then(loadAdmins);
  </script>
</body>
    </html>
