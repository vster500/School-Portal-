<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBnpne91aBQsRYefwHO5fcaGliJTo8jhMk",
    authDomain: "school-portal-233f5.firebaseapp.com",
    projectId: "school-portal-233f5",
    storageBucket: "school-portal-233f5.appspot.com",
    messagingSenderId: "314984934331",
    appId: "1:314984934331:web:92922fcc7a959e1fa0729e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  const superAdminEmail = "levisbonventure@gmail.com";
  const superAdminPassword = "wamalwa1";

  // Super admin login
  let isLoggedIn = false;
  signInWithEmailAndPassword(auth, superAdminEmail, superAdminPassword)
    .then(() => { 
      console.log("Super admin logged in");
      isLoggedIn = true;
      loadSchools(); // Load schools after login
    })
    .catch(err => alert("Login failed: " + err.message));

  const schoolList = document.getElementById("schoolList");
  const selectSchool = document.getElementById("selectSchool");

  // Load schools
  async function loadSchools() {
    const snap = await getDocs(collection(db, "schools"));
    schoolList.innerHTML = "";
    selectSchool.innerHTML = "<option value=''>Select School</option>";
    if(snap.empty){ 
      schoolList.innerHTML = "<p class='text-gray-500'>No schools registered yet</p>"; 
      return; 
    }
    snap.forEach(docSnap=>{
      const s = docSnap.data();
      const card = document.createElement("div");
      card.className = "p-4 bg-gray-50 border rounded-lg shadow";
      card.innerHTML = `<h3 class="font-bold">${s.name}</h3><p class="text-sm text-gray-600">${s.location || ""}</p>`;
      if(s.logo) card.innerHTML += `<img src="${s.logo}" class="w-20 h-20 mt-2 rounded"/>`;
      schoolList.appendChild(card);

      const opt = document.createElement("option");
      opt.value = docSnap.id; 
      opt.textContent = s.name;
      selectSchool.appendChild(opt);
    });
  }

  // Register new school
  document.getElementById("registerSchoolBtn").addEventListener("click", async () => {
    if(!isLoggedIn){
      alert("Super admin not logged in.");
      return;
    }

    const name = document.getElementById("schoolName").value.trim();
    const location = document.getElementById("schoolLocation").value.trim();
    const contact = document.getElementById("schoolContact").value.trim();
    const logoFile = document.getElementById("schoolLogo").files[0];

    if(!name || !location || !contact){
      document.getElementById("schoolStatus").textContent = "Please fill all fields.";
      return;
    }

    let logoURL = "";
    if(logoFile){
      try {
        const logoRef = ref(storage, `school_logos/${logoFile.name}_${Date.now()}`);
        await uploadBytes(logoRef, logoFile);
        logoURL = await getDownloadURL(logoRef);
      } catch(err) {
        document.getElementById("schoolStatus").textContent = "Logo upload failed: " + err.message;
        return;
      }
    }

    try {
      await addDoc(collection(db, "schools"), { name, location, contact, logo: logoURL });
      document.getElementById("schoolStatus").textContent = "School registered successfully!";
      // Clear input fields
      document.getElementById("schoolName").value = "";
      document.getElementById("schoolLocation").value = "";
      document.getElementById("schoolContact").value = "";
      document.getElementById("schoolLogo").value = "";
      // Refresh school list
      loadSchools();
    } catch(err) {
      document.getElementById("schoolStatus").textContent = "Failed to register: " + err.message;
    }
  });
</script>
